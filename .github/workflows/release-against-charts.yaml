name: Release Turtles against rancher/charts
on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch to use for GitHub action workflow"
        required: true
        default: "master"
      charts_ref:
        description: "Submit PR against the following rancher/charts branch (e.g. dev-v2.7)"
        required: true
        default: "dev-v2.8"
      prev_turtles:
        description: "Previous Turtles version (e.g. 0.6.0-rc.3)"
        required: true
        default: ""
      new_turtles:
        description: "New Turtles version"
        required: true
        default: ""
      prev_chart:
        description: "Previous Rancher Chart version (e.g. 101.1.0)"
        required: true
        default: ""
      new_chart:
        description: "New Rancher Chart version"
        required: true
        default: ""
      should_replace:
        description: "Should the old Turtles version be replaced/removed? (e.g. true in case of release candidate bumps)"
        required: true
        default: "true"

jobs:
  create-rancher-charts-pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{github.event.inputs.ref}}
          path: turtles
      - name: Checkout rancher/charts
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          repository: rancher/charts
          ref: ${{github.event.inputs.charts_ref}}
          path: charts
      - name: Run release script
        run: |
          ./rancher-turtles/.github/scripts/release-against-charts.sh ${{github.event.inputs.prev_turtles}} ${{github.event.inputs.new_turtles}} ${{github.event.inputs.prev_chart}}  ${{github.event.inputs.new_chart}}  ${{github.event.inputs.should_replace}}
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{secrets.CI_BOT_TOKEN}}
          push-to-fork: highlander-ci-bot/charts
          title: 'Update Turtles to v${{github.event.inputs.new_turtles}}'
          body: |
            Update Turtles to v${{github.event.inputs.new_turtles}}

            Changelog: https://github.com/rancher-sandbox/rancher-turtles/releases/tag/v${{github.event.inputs.new_turtles}}

            cc @rancher/highlander
          branch-suffix: timestamp
          base: ${{github.event.inputs.charts_ref}}
          path: ./charts/
